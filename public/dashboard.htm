<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SpotAlert Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <style>
    .card { background:#fff; padding:20px; border-radius:12px; margin-bottom:22px; }
    .face-item, .alert-item { border-left:4px solid #0073ff; padding:10px; margin-bottom:10px; }
    .danger { background:#ff4d4d;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer; }
    .muted { color:#777;font-size:14px; }
  </style>
</head>

<body>

<header class="frosted-header">
  <img src="spotalert_logo.png" class="logo" onclick="location.href='index.html'">
  <nav>
    <a href="dashboard.html" style="font-weight:700;">Dashboard</a>
    <a href="plans.html">Plans</a>
    <a href="#" onclick="logout()">Logout</a>
  </nav>
</header>

<div class="dashboard-container">

  <!-- PLAN -->
  <div id="currentPlan" class="plan-banner">Loading plan...</div>

  <!-- CAMERAS -->
  <div class="card">
    <h2>ðŸ“¡ Cameras</h2>
    <div id="cameraList" class="muted">Loading cameras...</div>
  </div>

  <!-- KNOWN FACES -->
  <div class="card">
    <h2>ðŸ‘¤ Known Faces</h2>
    <form id="faceForm">
      <input id="firstName" placeholder="First name" required>
      <input id="lastName" placeholder="Last name" required>
      <input id="faceImages" type="file" accept="image/*" multiple required>
      <button>Add Face</button>
    </form>
    <div id="faces"></div>
  </div>

  <!-- TEST DETECTION -->
  <div class="card">
    <h2>ðŸ§ª Test Detection</h2>
    <input type="file" id="testImage" accept="image/*">
    <button onclick="testDetect()">Upload</button>
    <div id="testResult"></div>
  </div>

  <!-- ALERTS -->
  <div class="card">
    <h2>ðŸš¨ Alerts</h2>
    <div id="alerts"></div>
  </div>

  <!-- USAGE / COST -->
  <div class="card">
    <h2>ðŸ“Š Usage & Cost</h2>
    <div id="usage"></div>
  </div>

</div>

<script>
const API = "https://api.spotalert.live";
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("spotalert_user") || "{}");

if (!token || !user.email) location.href="login.html";

document.getElementById("currentPlan").textContent = user.plan || "Free Trial";
const headers = () => ({ Authorization:"Bearer "+token });

/* ================= CAMERAS ================= */
async function loadCameras(){
  const el = document.getElementById("cameraList");
  try{
    const r = await fetch(`${API}/api/camera/list?email=${user.email}`,{headers:headers()});
    const cams = await r.json();
    el.innerHTML = cams.length ? "" : "<p class='muted'>No cameras registered.</p>";

    cams.forEach(c=>{
      el.innerHTML += `
        <div class="face-item">
          <strong>${c.name}</strong><br>
          IP: ${c.ip}<br>
          Status: <b>${c.status || "offline"}</b><br>
          Last seen: ${c.last_seen ? new Date(c.last_seen).toLocaleString() : "Never"}
        </div>`;
    });
  }catch(e){
    el.innerHTML = "<p class='muted'>Failed to load cameras.</p>";
  }
}

/* ================= KNOWN FACES ================= */
async function loadFaces(){
  const r = await fetch(`${API}/api/known-faces/list?email=${user.email}`,{headers:headers()});
  const d = await r.json();
  const el=document.getElementById("faces");
  el.innerHTML = d.length? "" : "<p class='muted'>No known faces.</p>";
  d.forEach(f=>{
    el.innerHTML += `
      <div class="face-item">
        <strong>${f.first_name} ${f.last_name}</strong><br>
        ${f.images} image(s)<br>
        <button class="danger" onclick="delFace(${f.id})">Delete</button>
      </div>`;
  });
}

document.getElementById("faceForm").onsubmit = async e=>{
  e.preventDefault();
  const fd=new FormData();
  fd.append("first_name",firstName.value);
  fd.append("last_name",lastName.value);
  fd.append("email",user.email);
  [...faceImages.files].forEach(f=>fd.append("images",f));
  await fetch(`${API}/api/known-faces/add`,{method:"POST",headers:headers(),body:fd});
  e.target.reset(); loadFaces();
};

async function delFace(id){
  if(!confirm("Delete face?"))return;
  await fetch(`${API}/api/known-faces/${id}`,{method:"DELETE",headers:headers()});
  loadFaces();
}

/* ================= TEST DETECTION ================= */
async function testDetect(){
  const f=testImage.files[0];
  if(!f)return;
  const fd=new FormData();
  fd.append("image",f);
  fd.append("email",user.email);
  const r=await fetch(`${API}/api/trigger-alert`,{method:"POST",body:fd});
  const d=await r.json();
  testResult.textContent = d.faces?.length ? "Known face detected" : "Unknown person detected";
  loadAlerts(); loadUsage();
}

/* ================= ALERTS ================= */
async function loadAlerts(){
  const r=await fetch(`${API}/api/alerts/list?type=all`,{headers:headers()});
  const d=await r.json();
  const el=document.getElementById("alerts");
  el.innerHTML=d.length? "" : "<p class='muted'>No alerts.</p>";
  d.slice(0,10).forEach(a=>{
    el.innerHTML+=`
      <div class="alert-item">
        ${a.type.toUpperCase()} â€“ ${new Date(a.timestamp).toLocaleString()}<br>
        Cost: $${a.cost}
      </div>`;
  });
}

/* ================= USAGE ================= */
async function loadUsage(){
  const r=await fetch(`${API}/api/usage-summary?email=${user.email}`,{headers:headers()});
  const u=await r.json();
  usage.innerHTML = `
    Month: ${u.month}<br>
    Total Cost: <strong>$${u.total_cost_usd}</strong>
  `;
}

/* ================= LOGOUT ================= */
function logout(){ localStorage.clear(); location.href="login.html"; }

/* INIT */
loadCameras();
loadFaces();
loadAlerts();
loadUsage();
</script>

</body>
</html>
